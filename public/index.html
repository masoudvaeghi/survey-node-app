<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <!-- بخش head بدون تغییر باقی می‌ماند -->
    <!-- ... -->
</head>
<body>
    <div class="container">
        <!-- تمام محتوای قبلی بدون تغییر -->
        <!-- ... -->
        
        <!-- اضافه کردن دکمه دانلود (در ابتدا مخفی) -->
        <div id="downloadSection" class="hidden">
            <a href="/download-csv" id="downloadBtn" class="download-btn">دانلود فایل CSV</a>
        </div>
    </div>

    <style>
        /* اضافه کردن استایل برای دکمه دانلود */
        .download-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            text-decoration: none;
            display: block;
            margin: 20px auto;
            text-align: center;
            width: 200px;
        }
        .download-btn:hover {
            background-color: #2980b9;
        }
    </style>

    <script>
        document.getElementById('surveyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // جمع‌آوری داده‌های فرم
            const formData = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                nationalCode: document.getElementById('nationalCode').value,
                age: document.getElementById('age').value,
                grade: document.getElementById('grade').value,
                academicStatus: document.getElementById('academicStatus').value,
                answers: {}
            };
            
            // جمع‌آوری پاسخ‌ها
            for (let i = 1; i <= 15; i++) {
                const selectedOption = document.querySelector(`input[name="q${i}"]:checked`);
                if (selectedOption) {
                    formData.answers[`q${i}`] = selectedOption.value;
                }
            }
            
            // ارسال داده به سرور
            fetch('/save-survey', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData),
            })
            .then(response => response.json())
            .then(data => {
                if (data.duplicate) {
                    // نمایش هشدار برای پاسخ تکراری
                    document.getElementById('duplicateWarning').classList.remove('hidden');
                    document.getElementById('surveyForm').classList.add('hidden');
                    
                    document.getElementById('confirmUpdate').addEventListener('click', function() {
                        // ارسال درخواست برای به‌روزرسانی
                        fetch('/update-survey', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(formData),
                        })
                        .then(() => {
                            document.getElementById('duplicateWarning').classList.add('hidden');
                            document.getElementById('thankYouMessage').classList.remove('hidden');
                            document.getElementById('downloadSection').classList.remove('hidden');
                        });
                    });
                    
                    document.getElementById('cancelUpdate').addEventListener('click', function() {
                        document.getElementById('duplicateWarning').classList.add('hidden');
                        document.getElementById('cancelMessage').classList.remove('hidden');
                    });
                } else {
                    // نمایش پیام تشکر و دکمه دانلود
                    document.getElementById('thankYouMessage').classList.remove('hidden');
                    document.getElementById('surveyForm').classList.add('hidden');
                    document.getElementById('downloadSection').classList.remove('hidden');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });

        // مدیریت کلیک روی دکمه دانلود
        document.getElementById('downloadBtn').addEventListener('click', function(e) {
            // این بخش اختیاری است و می‌توانید رفتار خاصی قبل از دانلود تعریف کنید
            console.log('درخواست دانلود فایل CSV ارسال شد');
        });
    </script>
</body>
</html>
